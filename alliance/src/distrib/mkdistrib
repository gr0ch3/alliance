#!/bin/sh
#
# Filename: build
# Copyright (C) 1999, 2000 Czo <Olivier.Sirol@lip6.fr>
# License: GPL (http://www.gnu.org/copyleft/gpl.html)
# Started: April 2000
# Last Change: Thursday 30 May 2002, 16:55
# Edit Time: 97:50:46
# Description:
#
# $Id: mkdistrib,v 1.1 2002/05/30 14:57:50 czo Exp $
#


WKSLIST="bip beny"
FTPDISTRIBDIR=/users/largo2/ftp/pub/alliance/unstable/distribution
LOGFILE=/tmp/albuild.$$

DATE=`date +%Y%m%d`

ALC_VER="5.0"
ALC_DIR="alliance-$ALC_VER"
ALC_PACK="$ALC_DIR-$DATE"

TMPDIR=tmp-$$
TMPBUILD=tmpbuild-$$
TMPINSTALL=tmpinstall-$$
TMPALLIANCE=alliance-tmp-$$

TMPDESTDIR=tmpdestdir-$$
TMPBUILDDIR=tmpbuilddir-$$

CVSROOT=/users/outil/alliance/cvsroot
export CVSROOT

echo "--> mk-distrib"

cd /users/soft5/newlabo/distrib || exit 4

echo "--> Removing old test..."
mv alliance $TMPDIR
rm -fr  $TMPDIR &

echo "--> Checkout CVS sources..."
cvs co -P alliance

echo "--> Makedist, generation de alliance-5.0.tar.gz"

cd alliance/src || exit 4

./autostuff
cd ..
mkdir TMPBUILD
mkdir TMPINSTALL
cd TMPBUILD

export ALLIANCE_TOP=/users/soft5/newlabo/distrib/alliance/TMPINSTALL

../src/configure --prefix=$ALLIANCE_TOP

make install
make distcheck

mv "$ALC_DIR.tar.gz" "$ALC_PACK.tar.gz"
cp -f "$ALC_PACK.tar.gz" $FTPDISTRIBDIR
mv -f "$ALC_PACK.tar.gz" ../..

cd ../..

mv alliance $TMPALLIANCE
(chmod -R 777 $TMPALLIANCE ; rm -fr $TMPALLIANCE)&

tar -xvzf "$ALC_PACK.tar.gz"


for WKS in WKSLIST
do
    mkdir $TMPDESTDIR-$WKS $TMPBUILDDIR-$WKS


ssh -n $WKS "cd $TMPBUILDDIR-$WKS ; \
export ALLIANCE_TOP=/usr/local/alliance ; \
../$ALC_DIR/src/configure --prefix=$ALLIANCE_TOP ; \
make DESTDIR="$TMPDESTDIR-$WKS$ALLIANCE_TOP" install"  2>&1 | tee $LOGFILE

done

echo "done..."
echo "###########   O K pour tout le monde   #############"








